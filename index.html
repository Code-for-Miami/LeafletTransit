<!DOCTYPE html>
<html data-ng-app="transitApp">

	<head>
		<title>Miami-Dade Transit</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css">
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.3.14/angular.min.js"></script>
		<script src="http://maps.google.com/maps/api/js?v=3&sensor=false"></script>
		<script src="googlemaps/Google.js"></script>

		<style>
			h1 {
			    color: #007AC2;
			    font-family:  Verdana, Geneva, sans-serif;
			    font-size: 32px;
			    text-align: center;
			    text-shadow: 2px 4px 3px rgba(0,0,0,0.3);
			}

			p {
				font-family:  Verdana, Geneva, sans-serif;
				color: #4F8636;
			}

			table, th, td {
			    border: 1px solid black;
			    border-collapse: collapse;
			}
			th,td {
			    padding: 15px;
			}
		</style>
	</head>

	<body >
		<h1>Miami-Dade Transit Live</h1>

		<div id="map" style="height: 600px; width: 90%; margin-left: auto; margin-right: auto;"></div>

		<div class="tabsection"
			style="margin-left: auto; margin-right: auto; width: 50%; padding: 20px 0px 0px 0px"
			data-ng-controller="transitController">
		    <ul class="nav nav-pills nav-justified">
		        <li class="active"><a data-toggle="tab" href="#livebuses">Live Buses</a></li>
		        <li><a data-toggle="tab" href="#busroutes">Bus Routes</a></li>
						<li><a data-toggle="tab" href="#busstops">Bus Stops</a></li>
						<li><a data-toggle="tab" href="#POIs">POIs</a></li>
						<li><a data-toggle="tab" href="#trolleys">Trolleys</a></li>
		    </ul>
		    <div class="tab-content">
		        <div id="livebuses" class="tab-pane fade in active">
		            <h3>Live Buses</h3>
								Live Buses: {{buses.length}}
								<div id="busTable">
			            <table>
										<tr>
											<th>Bus ID</th>
											<th>Trip ID</th>
									    <th>Route ID</th>
											<th>Service Direction</th>
											<th>Description</th>
											<!--<th>Route Color</th>-->
											<th>Last Updated</th>
									  </tr>
									  <tr data-ng-repeat="x in buses">
											<td>{{x.BusID}}</td>
									    <td>{{x.TripID}}</td>
									    <td><button class="btn btn-primary" onclick="focusRoute(this.innerHTML)">{{x.RouteID}}</button></td>
											<td>{{x.ServiceDirection}}</td>
											<td><button class="btn btn-primary" id="{{x.BusID}}" onclick="focusBus(this.id)">{{x.TripHeadsign}}</button></td>
									    <!--<td style="background-color: #{{x.color}}">{{x.color}}</td>-->
											<td>{{x.LocationUpdated}}</td>
										</tr>
									</table>
								</div>
		        </div>
		        <div id="busroutes" class="tab-pane fade">
		            <h3>Bus Routes</h3>
								Bus Routes: {{routes.length}}
								<div id="busroutesTable">
			            <table>
										<tr>
											<th>Route ID</th>
											<th>Route Alias</th>
									    <th>Route Description</th>
									    <th>Route Color</th>
									  </tr>
									  <tr data-ng-repeat="x in routes">
									    <td>{{x.RouteID}}</td>
											<td>{{x.RouteAliasLong}}</td>
									    <td>{{x.RouteDescription}}</td>
									    <td style="background-color: #{{x.RouteColor}}">{{x.RouteColor}}</td>
										</tr>
									</table>
								</div>
		        </div>
						<div id="busstops" class="tab-pane fade">
		            <h3>Bus Stops</h3>
								Stops: {{busStops[routeDir].length}} </br>
								Route:
								<select onchange="routeChanged(this.value)">
									<option data-ng-repeat="x in uniqueBusRoutes"
										value="{{x.RouteID}} {{x.ServiceDirection}}">{{x.RouteID}} {{x.ServiceDirection}}</option>
								</select>
								<div id="busStopTable">
			            <table>
										<tr>
											<th>Sequence</th>
											<th>Stop ID</th>
											<th>Stop Name</th>

									  </tr>
									  <tr data-ng-repeat="x in busStops[routeDir]">
											<td>{{x.Sequence}}</td>
									    <td>{{x.StopID}}</td>
											<td>{{x.StopName}}</td>
										</tr>
									</table>
								</div>
		        </div>
						<div id="POIs" class="tab-pane fade">
		            <h3>Points of Interest</h3>
								POIs: {{POIs.length}} </br>
								<div id="POIsTable">
			            <table>
										<tr>
											<th>POI ID</th>
											<th>Category</th>
									    <th>Category Name</th>
											<th>Name</th>
											<th>Address</th>
											<th>svHeading</th>
									  </tr>
									  <tr data-ng-repeat="x in POIs">
									    <td>{{x.PointID}}</td>
											<td><img src="icons/icon-POI-{{x.CategoryID}}.png" width="33" height="33">{{x.CategoryID}}</td>
									    <td>{{x.CategoryName}}</td>
											<td><button class="btn btn-primary" id="{{x.PointID}},{{x.Latitude}},{{x.Longitude}}" onclick="focusPOI(this.id)">{{x.PointName}}</button></td>
											<td>{{x.Address}}, {{x.City}}, {{x.State}} {{x.Zip}}</td>
											<td>{{x.svHeading}}</td>
										</tr>
									</table>
								</div>
		        </div>
						<div id="trolleys" class="tab-pane fade">
		            <h3>Trolleys</h3>
								City of Miami Trolleys: {{trolleys.length}} </br>
								<div id="trolleysTable">
			            <table>
										<tr>
											<th>Trolley ID</th>
											<th>Route ID</th>
											<th>In Service</th>
											<th>Next Stop ID</th>
											<th>Schedule Number</th>
									    <th>Receive Time</th>
									  </tr>
									  <tr data-ng-repeat="x in trolleys">
									    <td>{{x.equipmentID}}</td>
											<td>{{x.routeID}}</td>
											<td>{{x.inService}}</td>
											<td>{{x.nextStopID}}</td>
											<td>{{x.scheduleNumber}}</td>
									    <td>{{x.receiveTime}}</td>
										</tr>
									</table>
								</div>
		        </div>

		    </div>
		</div>

		<div class="bottom" style="margin-left: auto; margin-right: auto; width: 50%; padding: 20px 0px 0px 0px">
			<p>
				Data retrieved from: <a href="http://www.miamidade.gov/transit/WebServices/Buses/?BusID=">
					http://www.miamidade.gov/transit/WebServices/Buses/?BusID=</a>
				<br />
				When data is unavailable (night-time), sample data is shown.
				<br />
				Source code: <a href="https://github.com/qtrandev/LeafletTransit">
					https://github.com/qtrandev/LeafletTransit</a>
			</p>
		</div>

		<!-- All Javascript code to display the buses on the map -->
		<script src="index.js"></script>
		<!-- All Javascript code to store the XML data for the tables-->
		<script src="data.js"></script>

		<script>

		function routeChanged(rd) {
			scope.routeDir = rd;
			scope.$apply();
			var routeId = rd.split(" ")[0];
			focusRoute(routeId);
		}

		function focusPOI(poiIdLatLng) {
			var array = poiIdLatLng.split(",");
			var poiId = array[0];
			var lat = array[1];
			var lng = array[2];
			map.fitBounds(L.latLngBounds([poiMapping[poiId].getLatLng()]));
			poiMapping[poiId].openPopup();
			window.scrollTo(0, 0);
			getNearBy(poiId,lat,lng);
		}

		function focusRoute(routeId) {
			map.fitBounds(polylineMapping[routeId].getBounds());
			window.scrollTo(0, 0);
		}

		function focusBus(busId) {
			map.fitBounds(L.latLngBounds([busMapping[busId].getLatLng()]));
			busMapping[busId].openPopup();
			window.scrollTo(0, 0);
		}

		function getCitiBikes() {
			var source = "http://citibikemiami.com/downtown-miami-locations.xml";
			$.getJSON(
		       'http://anyorigin.com/dev/get?url='+source+'&callback=?',
		       (function(thisScope) {
						return function(data) {
							var xmlDoc = $.parseXML(data.contents);
							$xml = $( xmlDoc );

							$Id = $xml.find("Id");
							$Address = $xml.find("Address");
							$Distance = $xml.find("Distance");
							$Latitude = $xml.find("Latitude");
							$Longitude = $xml.find("Longitude");
							$Bikes = $xml.find("Bikes");
							$Dockings = $xml.find("Dockings");
							var i = 0;
	            for (i = 0; i < $Id.length; i++) {
								addBikeMarker(
									bikeLayer,
									$Latitude[i].textContent,
									$Longitude[i].textContent,
									$Id[i].textContent,
									$Address[i].textContent,
									$Bikes[i].textContent,
									$Dockings[i].textContent
								);
							}
						}
					}(scope))
			);
		}

		function addBikeMarker(layer, lat, lng, id, address, bikes, dockings) {
			var marker = L.marker([lat, lng], {icon: bikeIcon, zIndexOffset: -500}).bindPopup(
		      '<strong>Citi Bike Station ID: ' + id + '</strong><br><br>Address: ' + address + '<br>Bikes: ' +  bikes + '<br>Dockings: ' +  dockings,
		      { offset: new L.Point(0, -21) });
		  layer.addLayer(marker);
		}

		function getNearBy(poiId, lat, lng) {
			var source = "http://www.miamidade.gov/transit/WebServices/Nearby/?Lat="+lat+"&Long="+lng;
			//var source = "http://www.miamidade.gov/transit/WebServices/PointsOfInterestTransit/?PointID="+poiId;
			console.log("POI ID: "+poiId);
			console.log(source);
			processCachedNearby(poiId, lat, lng); //temp
			return; //temp
			$.getJSON(
				'http://anyorigin.com/dev/get?url='+source+'&callback=?',
				(function(thisScope, thisPOI) {
					return function(data) {
						console.log(data.contents);
						var xmlDoc = $.parseXML(data.contents);
						$xml = $( xmlDoc );

						$NearbyID = $xml.find("NearbyID");
						if ($NearbyID.length > 0) {
							console.log("Exit since we don't have code yet");
							return;
						} else {
							processCachedNearby(thisPOI, lat, lng);
						}
					}
				}(scope, poiId))
			);
		}

		function processCachedNearby(poiId, lat, lng) {
			if (nearbyCache.length > 0) {
				var i = 0;
				for (i = 0; i < nearbyCache.length; i++) {
					map.removeLayer(nearbyCache[i]);
				}
			}
			var xmlhttp=new XMLHttpRequest();
			xmlhttp.open("GET","./nearby/"+poiId+".xml",false);
			xmlhttp.send();
			if (xmlhttp.status!=200) {
				console.log("No local file exists for POI ID "+poiId+". Not displaying POI info.");
				return;
			}
			xmlDoc=xmlhttp.responseXML;
			$xml = $( xmlDoc );

			$NearbyID = $xml.find("NearbyID");
			$NearbyName = $xml.find("NearbyName");
			$NearbyType = $xml.find("NearbyType");
			$Descr = $xml.find("Descr");
			$Distance = $xml.find("Distance");
			$Latitude = $xml.find("Latitude");
			$Longitude = $xml.find("Longitude");
			nearbyCache = [];
			var bounds = [];
			var i = 0;
			for (i = 0; i < $NearbyID.length; i++) {
				addNearByMarker(
					nearbyLayer,
					$NearbyID[i].textContent,
					$NearbyName[i].textContent,
					$NearbyType[i].textContent,
					$Descr[i].textContent,
					$Distance[i].textContent,
					$Latitude[i].textContent,
					$Longitude[i].textContent,
					lat,
					lng
				);
				bounds[i] = [$Latitude[i].textContent,$Longitude[i].textContent];
			}
			map.fitBounds(bounds);
		}

		function addNearByMarker(layer, NearbyID, NearbyName, NearbyType, Descr, Distance, Latitude, Longitude, sourceLat, sourceLng) {
			var marker = L.marker([Latitude, Longitude], {icon: poiIcon, zIndexOffset: 10}).bindPopup(
				'<strong>'+NearbyType+'</strong><br /><br />'+
				'Name: '+NearbyName+
				'<br />Description: '+Descr+
				'<br />Distance: <strong>'+Distance+'</strong>'+
				'<br />Nearby ID: '+NearbyID,
		    { offset: new L.Point(0, -22) });
			/** Commented out to see if this code made the website unstable - blank map
			marker.on('mouseover', function (e) {
				this.openPopup();
			});
			**/
			marker.addTo(layer);
			nearbyCache.push(marker);
			var latlngs = [L.latLng(Latitude, Longitude), L.latLng(sourceLat, sourceLng)];
			var markerLine = L.polyline(latlngs, {color: 'aqua'});
			markerLine.addTo(layer);
			nearbyCache.push(markerLine);
		}

		</script>
	</body>

</html>
