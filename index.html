<!DOCTYPE html>
<html data-ng-app="demoApp">

	<head>
		<title>Miami Dade Transit</title>
		<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.css" />
		<script src="http://cdn.leafletjs.com/leaflet-0.7.3/leaflet.js"></script>
		<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
	</head>

	<body >
		<h1>Miami Dade Transit Leaflet Demo</h1>

		<div id="map" style="height: 480px"></div>

		<p>
			Data retrieved from 
			<a href="http://www.miamidade.gov/transit/WebServices/Buses/?BusID=">
				http://www.miamidade.gov/transit/WebServices/Buses/?BusID=</a>.
			<br />
			When data is unavailable (night-time), sample data is shown.
		</p>

		<script>

			/* This page is made to be one page to make it easier for new users to understand the code. 
			   Separate the scripts and css to separate files when project gets too big.
			 */
			
			// Initialize map
			var map = L.map('map').setView([25.80, -80.20], 8);
			var test = false; // Whether in test mode or online

			// Load MapBox map
			var accessToken = 'pk.eyJ1IjoicXRyYW5kZXYiLCJhIjoiSDF2cGNjZyJ9.D1ybOKe77AQDPHkxCCEpJQ';
			L.tileLayer('https://{s}.tiles.mapbox.com/v4/qtrandev.lc0i743k/{z}/{x}/{y}.png?access_token=' + accessToken, {
				maxZoom: 18,
				attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery Â© <a href="http://mapbox.com">Mapbox</a>'
			}).addTo(map);

			// Intialize bus icon
			var myIcon = L.icon({
			    iconUrl: 'mapIcon-Bus-Stop.png',
			    iconSize: [32, 32],
			    iconAnchor: [16, 32]
			});

			// Keep track of each route ID, trip ID, and its shape ID.
			var tripRouteShapeRef = []; // Format is {tripId: "", routeId: "", shapeId: "", color: ""}

			if (!test) {
				// Bypass cross-origin remote server access linmitation using anyorigin.com - can set up a proxy web server instead
				var dataSource = "http://www.miamidade.gov/transit/WebServices/Buses/?BusID=";
				$.getJSON('http://anyorigin.com/dev/get?url='+dataSource+'&callback=?',
					function(data){
						var xmlData = $.parseXML(data.contents);
						if (xmlData.getElementsByTagName("BusID").length > 0) {
							loadOnlineData(xmlData);
						} else {
							loadLocalData();
						}
					});
			} else {
				loadLocalData();
			}

			// Run when data is available from the transit website
			function loadOnlineData(xmlData) {
				generateBusList(xmlData, "REAL-TIME");
				loadRouteColors(); // Bus list must be loaded first
				displayRoutesFromTripId(tripRouteShapeRef); // Bus list must be loaded first to have the trip IDs
			}

			// Load local data from Buses.xml file for local testing or when online data is unavailable
			function loadLocalData() {
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET","Buses.xml",false);
				xmlhttp.send();
				xmlData=xmlhttp.responseXML;
				generateBusList(xmlData, "SAMPLE");
				loadRouteColors(); // Bus list must be loaded first
				displayRoutesFromTripId(tripRouteShapeRef); // Bus list must be loaded first to have the trip IDs
				if (!test) {
					alert("Real-time data is unavailable. Check the Miami Transit website. Using sample data.");
				}
			}

			// Create buses list from Miami Transit XML file
			function generateBusList(xmlDoc, realText) {
				var idList = xmlDoc.getElementsByTagName("BusID");
				var nameList = xmlDoc.getElementsByTagName("BusName");
				var latList = xmlDoc.getElementsByTagName("Latitude");
				var lonList = xmlDoc.getElementsByTagName("Longitude");
				var descList = xmlDoc.getElementsByTagName("TripHeadsign");
				var timeList = xmlDoc.getElementsByTagName("LocationUpdated");
				var tripList = xmlDoc.getElementsByTagName("TripID");
				var routeList = xmlDoc.getElementsByTagName("RouteID");
				for (i = 0; i < idList.length; i++) {
					// Add each bus to the map
					addBusMarker(
						latList[i].childNodes[0].nodeValue,
						lonList[i].childNodes[0].nodeValue,
						nameList[i].childNodes[0].nodeValue,
						descList[i].childNodes[0].nodeValue,
						idList[i].childNodes[0].nodeValue,
						timeList[i].childNodes[0].nodeValue,
						realText
					);
					// Add to the global trip-route-shape list
					//console.log("Adding Trip ID to list: "+tripList[i].childNodes[0].nodeValue+" Trip list size = "+tripRouteShapeRef.length);
					tripRouteShapeRef[tripRouteShapeRef.length] = {
						tripId: tripList[i].childNodes[0].nodeValue, 
						routeId: routeList[i].childNodes[0].nodeValue, 
						shapeId: ""
					};
				}
			}

			function loadRouteColors() {
				var xmlhttp=new XMLHttpRequest();
				xmlhttp.open("GET","BusRoutes.xml",false);
				xmlhttp.send();
				xmlData=xmlhttp.responseXML;

				var routeIdList = xmlData.getElementsByTagName("RouteID");
				//var descList = xmlData.getElementsByTagName("RouteDescription");
				var colorList = xmlData.getElementsByTagName("RouteColor");
				for (i = 0; i < routeIdList.length; i++) {
					// Add to global ref list
					// Data format is {tripId: "", routeId: "", shapeId: "", color: ""}
					var route = routeIdList[i].childNodes[0].nodeValue;
					for (j = 0; j < tripRouteShapeRef.length; j++) {
						if (tripRouteShapeRef[j].routeId == route) {
							tripRouteShapeRef[j].color = colorList[i].childNodes[0].nodeValue;
						}
					}
				}
			}

			function addBusMarker(lat, lon, name, desc, id, time, realText) {
				L.marker([lat, lon], {icon: myIcon}).addTo(map).bindPopup(
			    	realText+' ('+name+') Bus # '+desc+
			    	' (ID: '+id+') <br /> Location Updated: '+time,
			    	{ offset: new L.Point(0, -16) });
			}

			function displayRoutesFromTripId(tripRefs) {				
				for (i = 0; i < tripRefs.length; i++) {
					// Get shapeId for each trip
					//console.log("Trip ID retrieved: "+tripRefs[i].tripId);
					var source = 'http://www.miamidade.gov/transit/WebServices/BusRouteShapesByTrip/?TripID='+tripRefs[i].tripId;
					$.getJSON('http://anyorigin.com/dev/get?url='+source+'&callback=?',
					function(data){
						var shapeId = $.parseXML(data.contents).getElementsByTagName("ShapeID")[0].childNodes[0].nodeValue;
						//console.log("Shape ID retrieved: "+shapeId);
						displayFromShapeId(shapeId);
					});
					$.getJSON(
				       'http://anyorigin.com/dev/get?url='+source+'&callback=?',
				       (function(thistripId) {
				          return function(data) {
				            var shapeId = $.parseXML(data.contents).getElementsByTagName("ShapeID")[0].childNodes[0].nodeValue;
							//console.log("Shape ID retrieved: "+shapeId);
							// Add shape ID into global trip reference list
							// Data format is {tripId: "", routeId: "", shapeId: ""}
							for (i = 0; i < tripRouteShapeRef.length; i++) {
								if (tripRouteShapeRef[i].tripId == thistripId) {
									tripRouteShapeRef[i].shapeId = shapeId;
									//console.log("Updated shape ID into global list for trip ID: "+tripRouteShapeRef[i].tripId);
								}
							}
							displayFromShapeId(shapeId);
				          };
				       }(tripRefs[i].tripId))
				    );
				}
			}

			function displayFromShapeId(shapeId) {
				var source = 'http://www.miamidade.gov/transit/WebServices/BusRouteShape/?ShapeID='+shapeId;
				$.getJSON(
			       'http://anyorigin.com/dev/get?url='+source+'&callback=?',
			       (function(thisshapeId) {
			          return function(data) {
			            console.log("Data received. Displaying route from the Shape ID: "+thisshapeId);
			            // Find the color for the route
						var color = "";
						for (i = 0; i < tripRouteShapeRef.length; i++) {
							if (tripRouteShapeRef[i].shapeId == thisshapeId) {
								color = tripRouteShapeRef[i].color;
								break;
							}
						}
						addRoutePoints('#'+color, $.parseXML(data.contents));
			             // create a new closure on the parameter thisshapeId
			             // which will hold the correct value at invocation time
			          };
			       }(shapeId)) // calling the function with the current value
			    );
			}

			function addRoutePoints(routeColor, xmlDoc) {
				var latList = xmlDoc.getElementsByTagName("Latitude");
				var lonList = xmlDoc.getElementsByTagName("Longitude");
				var latlngs = [];
				for (i = 0; i < latList.length; i++) {
					//L.marker([latList[i].childNodes[0].nodeValue, lonList[i].childNodes[0].nodeValue], {icon: myIcon2}).addTo(map).bindPopup(
				    //	'Route # '+route,
				    //	{ offset: new L.Point(0, -20) });
					latlngs[latlngs.length] = (L.latLng(latList[i].childNodes[0].nodeValue, lonList[i].childNodes[0].nodeValue));
				}

				L.polyline(latlngs, {color: routeColor}).addTo(map);
			}

		</script>
	</body>

</html>